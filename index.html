<center>
<canvas id=canvas width=704 height=704 style="border:9px solid">
<script>

// Global vars

cellsize = 64;
gridsize = 11;

w = .6;
h = .8;

x = 0;
y = 0;

vx = .1;
vy = 0;

gravity = .04;
jump = -.3;
canjumpagain = 1;

grounded = 0;
dead = 0;
won = 0;
askshift = 0;
shifted = 0; // 1 == black background + reverse gravity
shiftframe = 0;

heroscale = 1;

c=canvas.getContext("2d");

// Keyboard
E=R=T=_=s=e=u=d=l=r=0;
onkeydown=onkeyup=z=>{
  //console.log(z.type);
  
  top['lurdlRdTl*urEu*_e**s'[(z.which+3)%20]]=z.type[3]<'u';
  if(!u) canjumpagain = 1;
  if(s){
    askshift = 1;
    //shiftframe = 10;
  }
}

// Map
m="00000000000\
00000000000\
00000000000\
00000000000\
00000000000\
00000000000\
11101110111\
11101110111\
11101110111\
11101110111\
11121112111";

// Get cell value at x:y
get = (x, y) => {
  X = Math.floor(x);
  Y = Math.floor(y);
  return parseInt(m[Y * gridsize + X]);
}

// Game loop
setInterval(()=>{

  // Reset
  canvas.width = canvas.width;

  // Draw map
  for(i=0;i<gridsize;i++){
    for(j=0;j<gridsize;j++){
      a=(m[j*gridsize+i]);
      if(a == 1){
        c.fillRect(i*cellsize,j*cellsize,cellsize,cellsize);
      }
      else if(a==9){
        c.fillRect(i*cellsize,j*cellsize+30,50,70);
        c.fillStyle="#fff";
        c.fillRect(i*cellsize+2,j*cellsize+2+30,40,60);
        c.fillStyle="#000";
      }
      else if(a==2){
        c.moveTo(i*cellsize, j*cellsize + cellsize);
        c.lineTo(i*cellsize + cellsize/4, j*cellsize);
        c.lineTo(i*cellsize + cellsize/2, j*cellsize + cellsize);
        c.lineTo(i*cellsize + cellsize/4*3, j*cellsize);
        c.lineTo(i*cellsize + cellsize, j*cellsize + cellsize);
        c.fill();
      }
    }
  }
  
  if(askshift){
    if(!shifted && (get(x,y+h) == 1 && get(x+w-.1,y+h) == 1)){
      shiftframe = 20;
      shifted = 1;
    }
  }
  
  else {
  
    // Apply speed to pos
    y += vy;
    
    // Set grounded 
    
    grounded = 0;
    
    // Hit screen bottom
    if(y + h > gridsize){
      y = gridsize - h;
      vy = 0;
      grounded = 1;
      //console.log(1);
    }
    
    // Hit solid cell bottom
    //console.log(x, y, get(x,y+h));
    if(vy > 0 && (get(x-w/2,y) == 1 || get(x+w/2-.1,y) == 1)){
      grounded = 1;
      vy = 0;
      y = Math.floor(y);
      //console.log(1);
      //canjumpagain = 1;
    }
    
    // ceil
    if(vy < 0 && (get(x,y) == 1 || get(x+w-.1,y) == 1)){
      vy = 0;
      y = Math.ceil(y);
    }
    
    
    
    // Gravity (fall)
    if(!grounded){//get(x, y + legs + 10) == 0){ 
      //grounded = false;
      vy += gravity;
    }
    
    // Hit ceiling
    if(y < 0){
      y = 0;
      vy = 0;
    }

    


    //console.log(canjumpagain, u, grounded);
    
    // Start jump
    if(u && grounded && canjumpagain){
      vy = jump;
      grounded = 0;
      canjumpagain = 0;
      //console.log(grounded);
    }
    
    // Press left
    if(l){
      x -= vx;
    }

    // Press right
    if(r){
      x += vx;
    }


    // Check spikes
    if(get(x,y) == 2 || get(x,y+h-.1) == 2 || get(x+w,y) == 2 || get(x+w,y+h-.1) == 2){
      dead = 1;
      //alert("dead");
    }
    
    
    // Check collisions
    
    
    
    // left
    if(x < 0){
      x = 0;
    }
    if(x > (gridsize - w)){
      x = gridsize - w;
    }
    if(l && (get(x,y) == 1 || get(x,y+h-.1) == 1)){
      x=Math.ceil(x);
    }
    // right
    if(r && (get(x+w,y) == 1 || get(x+w,y+h-.1) == 1)){
      x = Math.floor(x+w) - w;
    }
    
    
    
    
    // Draw hero
    c.fillStyle="#468";
    c.save();
    c.translate(x*cellsize+w/2,y*cellsize+h);
    c.scale(1, heroscale);
    c.fillRect(0,0, w*cellsize, -h*cellsize);
    c.restore();
    
    //c.font="60px a";
    //c.save();
    //c.translate(x, y);
    //c.scale(-1,1);
    //c.fillText("🏃\ufe0e", 0, 0);
    //c.restore(); 


    //console.log(y);
  }
  
  // Shift animation
  if(shiftframe) {
    shiftframe--;
    if(shiftframe >= 10){
      heroscale = -((15 - shiftframe) / 5);
      
    }
  }
  
  
  askshift = 0;
  
  console.log(x, y);
  
},33);

</script>
