<center>
<canvas id=canvas width=704 height=704 style="border:9px solid">
<script>

// Global vars

cellsize = 64;
gridsize = 11;

w = .6;
h = .8;

// hero's position
x = 0; // left hero's box
y = 0; // top of hero's box

speed_x = 0.1;
vx = 0;
vy = 0;

gravity = .04;
jump = -.3;
vymax = 1;

grounded = 0;
dead = 0;
won = 0;
askshift = 0;
shifted = 0; // 1 == black background + reverse gravity
shiftframe = 0;

heroscale = 1;
padding = 0.01;
c=canvas.getContext("2d");
canjumpagain = 0;
// Keyboard
E=R=T=_=s=e=u=d=l=r=0;
onkeydown=onkeyup=z=>{
  
  top['lurdlRdTl*urEu*_e**s'[(z.which+3)%20]]=z.type[3]<'u';
  if(!u) canjumpagain = 1;
  if(s){
    askshift = 1;
    //shiftframe = 10;
  }
}

// Map
m="00000000000\
00000000000\
00000000000\
00000000000\
01000000000\
00100000000\
11101110111\
11101110111\
11101110111\
11101110111\
11121112111";

// Get cell value at x:y
get = (x, y) => {
  X = Math.floor(x);
  Y = Math.floor(y);
  return parseInt(m[Y * gridsize + X]);
}

// Game loop
setInterval(()=>{

  // Reset
  canvas.width = canvas.width;

  // Draw map
  for(i=0;i<gridsize;i++){
    for(j=0;j<gridsize;j++){
      a=(m[j*gridsize+i]);
      if(a == 1){
        c.fillRect(i*cellsize,j*cellsize,cellsize,cellsize);
      }
      else if(a==9){
        c.fillRect(i*cellsize,j*cellsize+30,50,70);
        c.fillStyle="#fff";
        c.fillRect(i*cellsize+2,j*cellsize+2+30,40,60);
        c.fillStyle="#000";
      }
      else if(a==2){
        c.moveTo(i*cellsize, j*cellsize + cellsize);
        c.lineTo(i*cellsize + cellsize/4, j*cellsize);
        c.lineTo(i*cellsize + cellsize/2, j*cellsize + cellsize);
        c.lineTo(i*cellsize + cellsize/4*3, j*cellsize);
        c.lineTo(i*cellsize + cellsize, j*cellsize + cellsize);
        c.fill();
      }
    }
  }
  
  if(askshift){
    if(!shifted && (get(x,y+h) == 1 && get(x+w-.1,y+h) == 1)){
      shiftframe = 20;
      shifted = 1;
    }
  }
  
  else {
    //console.log(canjumpagain);
  
    // Apply speed to pos
    if(r){
      vx = speed_x;
    }
    else if(l){
      vx =-speed_x;
    }
    else{
      vx=0;
    }
    if(grounded && u && canjumpagain){  // jump
      canjumpagain = 1 - canjumpagain;
      vy = jump;
    }
    if(1-grounded){   // fall
      vy += gravity;
      vy = Math.min(vy, vymax);
    }
    y += vy;
    x += vx;
    
    // Check collisions:
    // - Hit screen: left, right, down or up
    // - Hit Box when going left, right, down or up

    // Hit screen bottom
    if(y + h > gridsize){
      //console.log("hit screen bottom");
      y = gridsize - h;
      vy = 0;
    }
    // Hit screen ceiling
    if(y<0){
      console.log("hit screen ceiling");
      y = 0;
      vy = 0;
    }
    // Hit screen left
    if(x<0){
      console.log("hit screen left");
      x=0;
    }
    // Hit screen right
    if(x + w >gridsize){
      console.log("hit screen right");
      x = gridsize - w;
    }
    
    // Hit Box up
    if((get(x,y) == 1 && get(x + padding,y) == 1)  || (get(x+w,y) == 1 && get(x+w - padding,y) == 1)){
      console.log("hit box up");
      vy=0;
      y = Math.ceil(y);
    }

    // Hit Box down
    if((vy >= 0) && ((get(x,y + h) == 1 && get(x+padding,y + h) == 1) || (get(x + w, y + h) == 1 && get(x + w - padding, y + h) == 1))){
      console.log("hit box down");
      vy = 0;
      y = Math.floor(y + h) - h;
    }

    // Hit box Left
    if((get(x, y) == 1 && get(x, y+padding) == 1) || (get(x, y+h) == 1 && get(x, y+h - padding) == 1)){
      console.log("hit box left");
      x = Math.ceil(x);
    }

    // Hit box right
    if((get(x+w,y) == 1 && get(x+w,y+padding) == 1) || (get(x+w, y+h) == 1 && get(x+w, y+h - padding) == 1)){
     console.log("hit box right");
      x = Math.floor(x + w) - w;
    }

    // Check spikes
    if(get(x,y) == 2 || get(x,y+h-.1) == 2 || get(x+w,y) == 2 || get(x+w,y+h-.1) == 2){
      dead = 1;
    }
    
    // Test grounded
    if((get(x, y+h) == 1 && get(x + padding, y+h) == 1) || (get(x+w - padding, y+h) == 1 && get(x+w, y+h) == 1)){
      grounded = 1;
    }
    else{
      grounded = 0;
    }   
    
    // Draw hero
    c.fillStyle="#468";
    c.save();
//    c.scale(1, heroscale);
    c.fillRect(x*cellsize,y*cellsize,w*cellsize, h*cellsize);
    c.restore();
    
    //c.font="60px a";
    //c.save();
    //c.translate(x, y);
    //c.scale(-1,1);
    //c.fillText("🏃\ufe0e", 0, 0);
    //c.restore(); 

  }
  
  // Shift animation
  if(shiftframe) {
    shiftframe--;
    if(shiftframe >= 10){
      heroscale = -((15 - shiftframe) / 5);
      
    }
  }
  
  
  askshift = 0;

  
},33);

</script>
